---
description: "Firebase SDK patterns, Firestore operations, and integration with TanStack Query"
globs: ["**/lib/firebase/**/*.ts", "**/store/**/*.ts", "**/components/features/**/*.tsx"]
alwaysApply: false
---

## Firebase Configuration

- **Firebase is pre-configured** in `src/lib/firebase/index.ts`
- **All configuration via environment variables** (no hardcoded keys)
- **Firebase app and Firestore** are initialized on import
- **Environment variables**: All Firebase config keys must be prefixed with `VITE_*`

### Setup Steps

1. **Get Firebase credentials** from Firebase Console
2. **Configure environment variables** in `.env`:
   ```env
   VITE_FIREBASE_API_KEY=your-api-key-here
   VITE_FIREBASE_AUTH_DOMAIN=your-project-id.firebaseapp.com
   VITE_FIREBASE_PROJECT_ID=your-project-id
   VITE_FIREBASE_STORAGE_BUCKET=your-project-id.appspot.com
   VITE_FIREBASE_MESSAGING_SENDER_ID=your-messaging-sender-id
   VITE_FIREBASE_APP_ID=your-app-id
   VITE_FIREBASE_MEASUREMENT_ID=your-measurement-id  # Optional
   ```

## Firebase Services

- **Firestore**: `db` - Pre-initialized Firestore database instance
- **Analytics**: `getAnalyticsInstance()` - Optional Analytics (lazy-loaded, requires measurementId)
- **Import from**: `import { db, getAnalyticsInstance } from '@/lib/firebase'`

## Firestore Operations

- **Use Firestore SDK** directly with TanStack Query for server state
- **Type all Firestore documents** with TypeScript interfaces
- **Use `serverTimestamp()`** for timestamps in Firestore documents
- **Handle Firestore errors** with proper error codes for i18n translation

### Example Pattern

```typescript
import { db } from '@/lib/firebase';
import { collection, addDoc, serverTimestamp } from 'firebase/firestore';

// In store or hook
await addDoc(collection(db, 'feedback'), {
    email: data.email,
    message: data.message,
    rating: data.rating,
    source: data.source,
    createdAt: serverTimestamp()
});
```

## Integration with TanStack Query

- **Firebase services work seamlessly** with TanStack Query
- **Use `useQuery` and `useMutation`** for Firestore operations
- **Handle loading and error states** in components

### Example

```typescript
import { useQuery } from '@tanstack/react-query';
import { db } from '@/lib/firebase';
import { collection, getDocs } from 'firebase/firestore';

const { data, isLoading } = useQuery({
    queryKey: ['feedback'],
    queryFn: async () => {
        const snapshot = await getDocs(collection(db, 'feedback'));
        return snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
    }
});
```

## Error Handling

- **Store error codes** (not error messages) in stores
- **Translate error codes** in components via i18n
- **Handle Firestore permission errors** with specific error codes (e.g., `permissionDenied`, `networkError`)

### Example Pattern

```typescript
// In store
try {
    await addDoc(collection(db, 'feedbacks'), data);
} catch (error) {
    const errorCode =
        error instanceof Error && error.message.includes('permission')
            ? 'permissionDenied'
            : 'networkError';
    set({ error: errorCode });
}

// In component
const { t } = useTranslation(['errors']);
const error = useFeedbackStore.use.error();
{error && <p>{t(`errors:feedback.${error}`)}</p>}
```
